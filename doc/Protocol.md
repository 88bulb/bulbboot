# BulbCast

BulbCast是基础灯通讯协议。全部使用BLE Advertisement实现，仅使用manufacturer data属性，最多有26字节容量，含4字节的magic和1字节的命令码。

## magic

使用`b01bca57`作为每个数据包的开头。

## address

每个灯有两个地址，一个是6字节的蓝牙地址，另一个是组播地址，每个灯被控制器分配一个组播地址。

组播地址的长度不是固定的；在分配时定义，其中包含固定长度的mask，例如：

```
addr:	97:ee:43:21:00:80:00:00
mask:	ff:ff:ff:ff:00:00:00:00 	
```

这是8字节地址，含32位的掩码；它意味着地址前面的32位事实上充当了组id的角色，其余的bit里原则上应只有一个bit是1，这样组播命令可以设置多个bit覆盖多个设备，例如指令的目标地址为

```
97:ee:43:21:00:80:04:10
```

可覆盖3个设备

```
97:ee:43:21:00:80:00:00
97:ee:43:21:00:00:04:00
97:ee:43:21:00:00:00:10
```

实际设备中暂定使用6字节组播地址，4字节（32bit）组id，余下16个bit分配给灯。

## command

因为协议设计足够简单且没有扩展性要求，命令和通讯类型（广播，组播，单播）合并用一个字节编码。

| -    | -            | payload                                        |                                                              |
| ---- | ------------ | ---------------------------------------------- | ------------------------------------------------------------ |
| 0x10 | 灯的广播     | 组播地址（optional）                           | b0:1b:ca:57::10 (5 bytes)<br />b0:1b:ca:57::10::97:ee:43:21:00:80 (11 bytes for 6-byte multicast address) |
| 0x20 | 设置灯的状态 | 蓝牙地址，RGBW，渐变时间                       | b0:1b:ca:57::20::72:65:63:72:75:69::ff:00:00:00:0a:00 (17 bytes)<br />经过1s渐变达到红色<br /> |
| 0x3n | 设置组播地址 | 组播地址，掩码位数，蓝牙地址，看门狗时间（秒） | b0:1b:ca:57::36::97:ee:43:21:00:04::20::72:65:63:72:75:69::14 (19 bytes for 6-byte multicast address)<br />设置组播地址97:ee:43:21:00:04/32给蓝牙地址为72:65:63:72:75:69的设备，看门狗20秒； |
| 0x40 | 设置灯的状态 | 组播地址，RGBW，渐变时间                       | b0:1b:ca:57::40::97:ee:43:21:02:06::ff:00:00:00:0a:00 (17 bytes for 6-byte multicast address) |
| 0xff | 重启         | 组播地址                                       | b0:1b:ca:57::ff::97:ee:43:21:ff:ff，重启组内所有设备         |

说明：

1. 渐变时间（transition time）的数据类型是`uint16_t`，使用little endian（least significant byte first），单位暂定为100ms；如果transition time设置为0（`00:00`），则esp32直接调用`set_duty`完成颜色设置，不使用transition功能。

2. 注意：渐变时间设置无法中断。
3. 设置组播地址的命令码可以是0x36~0x38，mask最好是8的整数倍；这样设计的原因是把组播码的位置对齐，方便看门狗工作；不然如果设置组播地址需要一个较长的时间，一直没有设置灯的状态的消息发出，控制器还需要专门发送假包喂狗，现在的设计方便灯使用0x3n包喂狗。

## watchdog

在设置了组播地址后，灯的看门狗开启，在规定时间内未能收到任何开头为`b0:1b:ca:57::nn::97:ee:43:21`的数据包，则灯泡重启；为了防止看门狗重启，控制器可以发送无效的设置灯的命令，例如：

```
b0:1b:ca:57::40::97:ee:43:21:00:00::nn:nn:nn:nn:nn:nn
```

多播掩码全部填写0，不会影响任何灯的状态，仅仅起到延迟看门狗的作用；
